name: Claude Develop

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  time-gate:
    if: github.event.label.name == 'approved'
    uses: ./.github/workflows/check-work-hours.yml
    with:
      issue_number: ${{ github.event.issue.number }}

  develop:
    needs: time-gate
    if: needs.time-gate.outputs.allowed == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    concurrency:
      group: claude-dev-${{ github.event.issue.number }}
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT }}

      - name: Write issue context to files
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT }}
          script: |
            const fs = require('fs');
            const issue = context.payload.issue;
            fs.writeFileSync('/tmp/issue-title.txt', issue.title);
            fs.writeFileSync('/tmp/issue-body.txt', issue.body || '');
            fs.writeFileSync('/tmp/issue-number.txt', String(issue.number));

            // Get the plan from the last bot comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              per_page: 50
            });
            const planComment = comments
              .filter(c => c.body.startsWith('## Implementation Plan'))
              .pop();
            fs.writeFileSync('/tmp/plan-comment.txt', planComment ? planComment.body : 'No plan found');

      - name: Set up Git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create feature branch
        run: |
          BRANCH="claude/issue-${{ github.event.issue.number }}"
          git checkout -b "$BRANCH"
          echo "BRANCH=$BRANCH" >> "$GITHUB_ENV"

      - name: Update labels
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT }}
          script: |
            const issue = context.issue.number;
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner, repo: context.repo.repo,
                issue_number: issue, name: 'approved'
              });
            } catch (e) {}
            await github.rest.issues.addLabels({
              owner: context.repo.owner, repo: context.repo.repo,
              issue_number: issue, labels: ['in-development']
            });

      - uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: uv sync --dev

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Implement feature
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          ISSUE_TITLE=$(cat /tmp/issue-title.txt)
          ISSUE_BODY=$(cat /tmp/issue-body.txt)
          ISSUE_NUM=$(cat /tmp/issue-number.txt)
          PLAN_COMMENT=$(cat /tmp/plan-comment.txt)

          cat <<PROMPT_EOF | claude --model claude-opus-4-6 --max-turns 25 --dangerously-skip-permissions -p -
          You are implementing a feature for the AnimeForge project.

          ## Issue #${ISSUE_NUM}: ${ISSUE_TITLE}

          ${ISSUE_BODY}

          ## Implementation Plan

          ${PLAN_COMMENT}

          ## Instructions

          1. Read CLAUDE.md to understand project conventions
          2. Implement the feature following the plan
          3. Run \`uv run ruff check src/\` and fix any lint errors
          4. Run \`uv run pytest\` and fix any test failures
          5. Commit your changes with a descriptive message
          6. Do NOT push â€” the workflow will handle that

          Important:
          - Follow existing code patterns and conventions
          - Add tests for new functionality
          - Keep changes focused on the issue
          PROMPT_EOF

      - name: Push branch and create PR
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          ISSUE_NUM=$(cat /tmp/issue-number.txt)
          ISSUE_TITLE=$(cat /tmp/issue-title.txt)

          # Check if there are commits to push
          if git diff --quiet origin/main; then
            echo "No changes to push"
            exit 0
          fi

          git push -u origin "$BRANCH"

          PR_URL=$(gh pr create \
            --title "feat: ${ISSUE_TITLE}" \
            --body "$(cat <<EOF
          Resolves #${ISSUE_NUM}

          ## Summary
          Automated implementation by Claude Code.

          ## Test Plan
          - [ ] CI passes (lint + type check + tests)
          - [ ] Coverage maintained or improved
          - [ ] Manual review of changes

          Generated with [Claude Code](https://claude.ai/code)
          EOF
          )" \
            --head "$BRANCH" \
            --base main)

          echo "Created PR: $PR_URL"
